<project xmlns="http://maven.apache.org/POM/4.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.example</groupId>
  <artifactId>magma</artifactId>
  <version>0.1.0-SNAPSHOT</version>
  <properties>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter</artifactId>
      <version>5.10.0</version>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.1.2</version>
        <configuration>
          <useModulePath>false</useModulePath>
          <!-- Run tests in-process to avoid forked-JVM classfile version mismatches -->
          <forkCount>0</forkCount>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-pmd-plugin</artifactId>
        <version>3.22.0</version>
        <executions>
          <execution>
            <id>pmd-and-cpd</id>
            <!-- Run PMD/CPD during the test phase so 'mvn test' will perform the checks -->
            <phase>test</phase>
            <goals>
              <goal>pmd</goal>
              <goal>cpd-check</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <!-- Configure CPD to use 5 tokens as requested -->
          <minimumTokens>10</minimumTokens>
          <!-- Do not fail immediately; we'll print details and fail later with clearer output -->
          <failOnViolation>false</failOnViolation>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-checkstyle-plugin</artifactId>
        <version>3.2.2</version>
        <executions>
          <execution>
            <id>checkstyle</id>
            <!-- Run checkstyle during the test phase so 'mvn test' enforces style rules -->
            <phase>test</phase>
            <goals>
              <goal>check</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <!-- relative to project root -->
          <configLocation>config/checkstyle/checkstyle.xml</configLocation>
          <failOnViolation>true</failOnViolation>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-antrun-plugin</artifactId>
        <version>3.1.0</version>
        <executions>
          <execution>
            <id>print-cpd-and-fail-if-dup</id>
            <phase>test</phase>
            <goals>
              <goal>run</goal>
            </goals>
            <configuration>
              <target>
                <!-- Load the CPD XML into a property -->
                <loadfile property="cpd.content" srcFile="${project.build.directory}/cpd.xml" />
                <!-- Check if the CPD output contains a <duplication> element -->
                <condition property="cpd.has.duplication">
                  <contains string="${cpd.content}" substring="&lt;duplication" />
                </condition>
                <!-- If duplicates exist, print the CPD XML to the console for easy debugging -->
                <!-- Only print CPD/PMD output when duplication was detected.
                Use <fail> with an if-condition so the CPD content is displayed only when duplicates exist. -->
                <!-- Store the CPD content in a property and fail with that message when duplication
                detected -->
                <property name="cpd.report.message"
                  value="----- CPD report (if any) -----&#10;${cpd.content}" />
                <fail if="cpd.has.duplication" message="${cpd.report.message}" />
                <!-- Fail the build if duplication was detected -->
                <fail message="CPD detected duplication. See ${project.build.directory}/cpd.xml"
                  if="cpd.has.duplication" />
              </target>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>